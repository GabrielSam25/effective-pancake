const express = require('express');
const axios = require('axios');
const cheerio = require('cheerio');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// Configurar axios para simular um navegador real
const axiosInstance = axios.create({
    headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'pt-BR,pt;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'keep-alive',
        'Upgrade-Insecure-Requests': '1',
    },
    timeout: 30000
});

// Fun√ß√£o para extrair dados da s√©rie
async function extractSeriesData(url) {
    try {
        console.log(`üîç Acessando URL: ${url}`);
        
        const response = await axiosInstance.get(url);
        console.log(`üìÑ Status: ${response.status}, Tamanho: ${response.data.length}`);
        
        const $ = cheerio.load(response.data);
        
        const seriesData = {
            title: '',
            seasons: []
        };

        // Extrair t√≠tulo da p√°gina
        const pageTitle = $('title').text();
        console.log('üìù T√≠tulo da p√°gina:', pageTitle);
        
        // Limpar o t√≠tulo
        seriesData.title = pageTitle.replace('(Dublado)', '').replace('(Legendado)', '').trim();

        // Estrat√©gia 1: Procurar por elementos espec√≠ficos que contenham os dados
        console.log('üîç Procurando por conte√∫do...');

        // Buscar todas as tags que podem conter os epis√≥dios
        const contentSelectors = [
            'p',
            'div',
            'section',
            'article',
            '.content',
            '#content',
            '.episodes',
            '.season'
        ];

        let foundContent = null;

        for (const selector of contentSelectors) {
            const elements = $(selector);
            console.log(`üîç Seletor "${selector}": ${elements.length} elementos`);
            
            elements.each((index, element) => {
                const $element = $(element);
                const text = $element.text();
                
                // Verificar se cont√©m informa√ß√µes de epis√≥dios
                if (text.includes('Epis√≥dio') && text.includes('Temporada')) {
                    console.log(`‚úÖ Poss√≠vel container encontrado com: ${selector}`);
                    console.log(`üìã Amostra: ${text.substring(0, 100)}...`);
                    foundContent = $element;
                    return false; // break
                }
            });
            
            if (foundContent) break;
        }

        // Se n√£o encontrou, usar o body
        if (!foundContent) {
            console.log('‚ÑπÔ∏è Usando body como fallback');
            foundContent = $('body');
        }

        // Extrair todo o texto para an√°lise
        const fullText = foundContent.text();
        console.log('üìã Texto completo (primeiros 500 chars):', fullText.substring(0, 500));

        // Processar o conte√∫do
        const lines = fullText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        
        let currentSeason = null;
        const seasons = [];

        lines.forEach((line, index) => {
            // Verificar se √© uma temporada
            if (line.match(/\d+¬™\s*Temporada/i) || line.includes('Temporada')) {
                console.log(`üé¨ Temporada encontrada: ${line}`);
                
                if (currentSeason && currentSeason.episodes.length > 0) {
                    seasons.push(currentSeason);
                }
                
                currentSeason = {
                    season: line,
                    episodes: []
                };
                return;
            }

            // Verificar se √© um epis√≥dio
            if (line.includes('Epis√≥dio') && currentSeason) {
                console.log(`üì∫ Epis√≥dio encontrado: ${line}`);
                
                const episodeData = extractEpisodeFromText(line, foundContent);
                if (episodeData) {
                    currentSeason.episodes.push(episodeData);
                }
            }
        });

        // Adicionar a √∫ltima temporada
        if (currentSeason && currentSeason.episodes.length > 0) {
            seasons.push(currentSeason);
        }

        seriesData.seasons = seasons;

        console.log(`üìä Resumo: ${seasons.length} temporadas, ${seasons.reduce((acc, s) => acc + s.episodes.length, 0)} epis√≥dios`);

        return seriesData;

    } catch (error) {
        console.error('‚ùå Erro ao extrair dados:', error.message);
        throw new Error(`Erro ao extrair dados: ${error.message}`);
    }
}

// Fun√ß√£o para extrair epis√≥dio do texto
function extractEpisodeFromText(line, $container) {
    try {
        const episodeData = {
            episode: '',
            title: '',
            links: {}
        };

        // Extrair n√∫mero do epis√≥dio
        const episodeMatch = line.match(/Epis√≥dio\s+(\d+)/i);
        if (episodeMatch) {
            episodeData.episode = `Epis√≥dio ${episodeMatch[1]}`;
        }

        // Extrair t√≠tulo (se existir)
        const titleMatch = line.match(/Epis√≥dio\s+\d+\s*-\s*(.+?)(?:\s*$)/i);
        if (titleMatch && titleMatch[1].trim() && titleMatch[1].trim() !== '-') {
            episodeData.title = titleMatch[1].trim();
        }

        // Buscar links no container - estrat√©gia mais agressiva
        $container.find('a').each((i, link) => {
            const $link = $(link);
            const href = $link.attr('href');
            const text = $link.text().trim();
            const parentText = $link.parent().text();

            // Verificar se este link est√° relacionado ao epis√≥dio atual
            if (href && parentText.includes(line.substring(0, 20))) {
                const fullUrl = `https://redecanais.sh${href}`;
                
                if (text === 'Assistir' || text === 'Dublado' || text === 'Legendado') {
                    episodeData.links[text.toLowerCase()] = fullUrl;
                } else if (text && !episodeData.links.assistir) {
                    episodeData.links.assistir = fullUrl;
                }
            }
        });

        return Object.keys(episodeData.links).length > 0 ? episodeData : null;

    } catch (error) {
        console.error('‚ùå Erro ao extrair epis√≥dio:', error);
        return null;
    }
}

// Endpoint principal
app.get('/api/series', async (req, res) => {
    const { url } = req.query;

    console.log(`üìç Recebida requisi√ß√£o para URL: ${url}`);

    if (!url) {
        return res.status(400).json({
            error: 'URL √© obrigat√≥ria. Use: /api/series?url=URL_DA_SERIE'
        });
    }

    try {
        if (!url.includes('redecanais.sh')) {
            return res.status(400).json({
                error: 'URL deve ser do dom√≠nio redecanais.sh'
            });
        }

        const seriesData = await extractSeriesData(url);
        
        res.json({
            success: true,
            data: seriesData,
            debug: {
                url: url,
                timestamp: new Date().toISOString(),
                seasonsCount: seriesData.seasons.length,
                totalEpisodes: seriesData.seasons.reduce((acc, season) => acc + season.episodes.length, 0)
            }
        });

    } catch (error) {
        console.error('‚ùå Erro na API:', error);
        res.status(500).json({
            success: false,
            error: error.message,
            debug: {
                url: url,
                timestamp: new Date().toISOString()
            }
        });
    }
});

// Endpoint de debug melhorado
app.get('/api/debug', async (req, res) => {
    const { url } = req.query;

    if (!url) {
        return res.status(400).json({ error: 'URL √© obrigat√≥ria' });
    }

    try {
        const response = await axiosInstance.get(url);
        const $ = cheerio.load(response.data);

        // Coletar informa√ß√µes √∫teis
        const info = {
            url: url,
            status: response.status,
            title: $('title').text(),
            metaDescription: $('meta[name="description"]').attr('content'),
            bodyLength: $('body').text().length,
            allLinks: $('a').length,
            possibleContentElements: []
        };

        // Encontrar elementos que podem conter o conte√∫do
        $('p, div, section, article').each((index, element) => {
            const $element = $(element);
            const text = $element.text().trim();
            
            if (text && (text.includes('Epis√≥dio') || text.includes('Temporada'))) {
                info.possibleContentElements.push({
                    tag: element.tagName,
                    class: $element.attr('class'),
                    id: $element.attr('id'),
                    text: text.substring(0, 150),
                    links: $element.find('a').length
                });
            }
        });

        // Amostra do HTML
        info.htmlSample = response.data.substring(0, 2000);

        res.json(info);

    } catch (error) {
        res.status(500).json({ 
            error: error.message,
            response: error.response ? {
                status: error.response.status,
                headers: error.response.headers
            } : null
        });
    }
});

// Endpoint de sa√∫de
app.get('/health', (req, res) => {
    res.json({ 
        status: 'API funcionando', 
        timestamp: new Date().toISOString(),
        version: '1.1.0'
    });
});

app.get('/', (req, res) => {
    res.json({
        message: 'API de Extra√ß√£o de S√©ries - Rede Canais v1.1',
        endpoints: {
            '/api/series': 'Extrair dados da s√©rie',
            '/api/debug': 'Debug detalhado',
            '/health': 'Status da API'
        },
        exemplo: 'https://effective-pancake-wgc5.onrender.com/api/series?url=https://redecanais.sh/browse-alice-in-borderland-videos-1-date.html'
    });
});

app.listen(PORT, () => {
    console.log(`üöÄ Servidor rodando na porta ${PORT}`);
    console.log(`üì° Acesse: http://localhost:${PORT}`);
});
